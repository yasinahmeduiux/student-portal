<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Management | Student Portal</title>
    
    <!-- Load Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Load Inter Font and Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f7f9;
        }
        .main-content {
            min-height: calc(100vh - 56px - 2rem);
        }
        .payment-option-card {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid #e9ecef;
            border-radius: 0.5rem;
        }
        .payment-option-card:hover {
            border-color: #007bff;
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.1);
        }
        .payment-option-card.selected {
            border: 3px solid #007bff;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.3);
        }
        .gateway-logo {
            max-height: 40px;
        }
        .transaction-status-badge {
            font-weight: 600;
        }
    </style>
</head>
<body>

    <!-- 1. Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="dashboard.html">
                <i class="bi bi-book-half me-2"></i> Student Portal
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="course.html">Course Management</a></li>
                    <li class="nav-item"><a class="nav-link" href="academic.html">Academic History</a></li>
                    <li class="nav-item"><a class="nav-link active" aria-current="page" href="payment.html">Payment</a></li>
                    <li class="nav-item"><a class="nav-link btn btn-outline-light btn-sm ms-lg-3" href="index.html">Log Out</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="container py-4 main-content">
        <h2 class="mb-4 fw-light text-primary">Payment Management</h2>
        
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" id="paymentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pay-tab" data-bs-toggle="tab" data-bs-target="#pay" type="button" role="tab" aria-controls="pay" aria-selected="true">
                    Pay Tuition & Fees
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">
                    Payment History & Receipts
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="paymentTabsContent">

            <!-- TAB 1: Pay Tuition & Fees -->
            <div class="tab-pane fade show active" id="pay" role="tabpanel" aria-labelledby="pay-tab">
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white fw-bold">
                        Outstanding Balance Summary
                    </div>
                    <div class="card-body row g-3 align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-1 text-danger">Total Due: <span id="totalDue">$1,250.00</span></h4>
                            <p class="text-muted mb-0">Due Date: November 30, 2025</p>
                        </div>
                        <div class="col-md-6 d-flex justify-content-md-end">
                            <label for="paymentAmount" class="col-form-label me-2">Amount to Pay:</label>
                            <input type="number" id="paymentAmount" value="1250.00" min="1.00" step="0.01" class="form-control w-50 me-2" required>
                            <span class="col-form-label fw-bold">USD</span>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white fw-bold">
                        Select Payment Method
                    </div>
                    <div class="card-body">
                        <div class="row g-4" id="paymentGatewayOptions">
                            
                            <!-- Option 1: Bank Card (MasterCard/Visa) -->
                            <div class="col-md-4">
                                <div class="payment-option-card card h-100 p-3 text-center selected" data-gateway="card">
                                    <img src="https://placehold.co/100x40/007bff/ffffff/png?text=MASTER%26VISA" alt="Card" class="gateway-logo mx-auto mb-2">
                                    <p class="mb-0 fw-bold">Credit / Debit Card</p>
                                    <small class="text-muted">MasterCard, Visa, etc.</small>
                                </div>
                            </div>
                            
                            <!-- Option 2: PayPal -->
                            <div class="col-md-4">
                                <div class="payment-option-card card h-100 p-3 text-center" data-gateway="paypal">
                                    <img src="https://placehold.co/100x40/00457C/ffffff/png?text=PayPal" alt="PayPal" class="gateway-logo mx-auto mb-2">
                                    <p class="mb-0 fw-bold">PayPal</p>
                                    <small class="text-muted">Pay securely with your PayPal account.</small>
                                </div>
                            </div>

                            <!-- Option 3: Skrill -->
                            <div class="col-md-4">
                                <div class="payment-option-card card h-100 p-3 text-center" data-gateway="skrill">
                                    <img src="https://placehold.co/100x40/59C149/ffffff/png?text=Skrill" alt="Skrill" class="gateway-logo mx-auto mb-2">
                                    <p class="mb-0 fw-bold">Skrill</p>
                                    <small class="text-muted">Wallet and direct bank transfer.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Card Details Form (Initially shown for 'card' gateway) -->
                        <form id="cardPaymentForm" class="mt-5">
                            <h5 class="mb-3 text-secondary">Card Details</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="cardNumber" class="form-label">Card Number</label>
                                    <input type="text" id="cardNumber" class="form-control" placeholder="**** **** **** 1234" required pattern="\d{16}" title="16-digit card number">
                                </div>
                                <div class="col-md-6">
                                    <label for="cardName" class="form-label">Name on Card</label>
                                    <input type="text" id="cardName" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="cardExpiry" class="form-label">Expiry Date (MM/YY)</label>
                                    <input type="text" id="cardExpiry" class="form-control" placeholder="12/28" required pattern="\d{2}/\d{2}" title="MM/YY">
                                </div>
                                <div class="col-md-4">
                                    <label for="cardCvv" class="form-label">CVV</label>
                                    <input type="text" id="cardCvv" class="form-control" placeholder="123" required pattern="\d{3,4}" title="3 or 4 digits">
                                </div>
                            </div>
                            <button type="button" class="btn btn-success btn-lg mt-5 w-100" onclick="processPayment()">
                                Pay <span id="payButtonAmount">$1,250.00</span> Now
                            </button>
                        </form>
                        
                        <!-- Dynamic Info/Link for Skrill/PayPal (Hidden by default) -->
                        <div id="externalPaymentInfo" class="mt-5 p-4 bg-light rounded shadow-sm hidden" style="display: none;">
                            <h5 class="mb-3 text-secondary" id="externalGatewayTitle"></h5>
                            <p id="externalGatewayText"></p>
                            <button class="btn btn-primary btn-lg" onclick="initiateExternalPayment()">
                                Proceed to <span id="externalGatewayName"></span> Secure Checkout
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: Payment History & Receipts -->
            <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-bold">
                        Past Transactions
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Transaction ID</th>
                                        <th>Amount</th>
                                        <th>Item</th>
                                        <th>Status</th>
                                        <th>Receipt</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTable">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End of Container -->

    <!-- Toast Notification (for success/error messages) -->
    <div id="toast" class="fixed-bottom-0 right-0 p-3" style="z-index: 11; right: 0; bottom: 0;">
        <div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header" id="toastHeader">
                <strong class="me-auto" id="toastTitle">Payment Status</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody"></div>
        </div>
    </div>

    <!-- 2. Bootstrap JS Bundle (Includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 3. Dynamic Payment Management JavaScript (js/payment.js logic placed inline) -->
    <script>
        // Mock data for past transactions
        const mockTransactions = [
            { date: '2025-09-01', id: 'TXN12345', amount: 1000.00, item: 'Tuition Fee - Installment 2', status: 'Completed' },
            { date: '2025-07-15', id: 'TXN12344', amount: 50.00, item: 'Library Fine', status: 'Completed' },
            { date: '2025-05-20', id: 'TXN12343', amount: 1200.00, item: 'Tuition Fee - Installment 1', status: 'Failed' },
        ];

        let selectedGateway = 'card';
        
        // --- Utility Functions ---
        
        function showToast(title, body, type = 'success') {
            const toastElement = document.getElementById('liveToast');
            const toastTitle = document.getElementById('toastTitle');
            const toastBody = document.getElementById('toastBody');
            const toastHeader = document.getElementById('toastHeader');
            
            // Set colors based on type
            toastHeader.className = `toast-header text-white ${type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-primary'}`;
            toastTitle.textContent = title;
            toastBody.textContent = body;

            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }

        function getStatusBadge(status) {
            let className = '';
            if (status === 'Completed') {
                className = 'bg-success';
            } else if (status === 'Pending') {
                className = 'bg-warning text-dark';
            } else {
                className = 'bg-danger';
            }
            return `<span class="badge ${className} transaction-status-badge">${status}</span>`;
        }
        
        // --- Core Rendering Functions ---

        function renderTransactions() {
            const tableBody = document.getElementById('transactionsTable');
            tableBody.innerHTML = '';
            
            mockTransactions.forEach(t => {
                const date = new Date(t.date).toLocaleDateString();
                const amount = `$${t.amount.toFixed(2)}`;
                const row = `
                    <tr>
                        <td>${date}</td>
                        <td>${t.id}</td>
                        <td>${amount}</td>
                        <td>${t.item}</td>
                        <td>${getStatusBadge(t.status)}</td>
                        <td>
                            ${t.status === 'Completed' ? 
                                `<button class="btn btn-sm btn-outline-primary" onclick="viewReceipt('${t.id}')">View Receipt</button>` : 
                                'N/A'
                            }
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        // --- Interaction Handlers ---

        function selectGateway(gateway) {
            selectedGateway = gateway;
            
            // 1. Update card selection visualization
            document.querySelectorAll('.payment-option-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.payment-option-card[data-gateway="${gateway}"]`).classList.add('selected');

            // 2. Toggle forms/info based on selection
            const cardForm = document.getElementById('cardPaymentForm');
            const externalInfo = document.getElementById('externalPaymentInfo');

            if (gateway === 'card') {
                cardForm.style.display = 'block';
                externalInfo.style.display = 'none';
            } else {
                cardForm.style.display = 'none';
                externalInfo.style.display = 'block';
                
                const title = gateway === 'paypal' ? 'PayPal Secure Payment' : 'Skrill Wallet Checkout';
                const text = gateway === 'paypal' ? 'You will be redirected to PayPal to complete your payment securely.' : 'You will be redirected to the Skrill gateway to log in and authorize payment.';
                
                document.getElementById('externalGatewayTitle').textContent = title;
                document.getElementById('externalGatewayText').textContent = text;
                document.getElementById('externalGatewayName').textContent = gateway;
            }
            console.log(`Payment gateway set to: ${gateway}`);
        }

        function processPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            if (selectedGateway === 'card') {
                const form = document.getElementById('cardPaymentForm');
                
                // Simple form validation check
                if (form.checkValidity() === false) {
                    form.reportValidity();
                    showToast('Error', 'Please fill out all card details correctly.', 'error');
                    return;
                }
                
                // Simulate processing
                console.log(`Processing card payment of $${amount} via Card...`);
                showToast('Processing', 'Your payment is being processed...', 'primary');
                
                // Simulate success after 2 seconds
                setTimeout(() => {
                    showToast('Success', `Payment of $${amount.toFixed(2)} completed successfully!`, 'success');
                    // Add mock transaction to history and re-render
                    mockTransactions.unshift({ date: new Date().toISOString().split('T')[0], id: 'TXN' + Date.now().toString().slice(-6), amount: amount, item: 'Tuition/Fee Payment', status: 'Completed' });
                    renderTransactions();
                }, 2000);
            
            } else {
                // This shouldn't happen if external is shown, but included for completeness
                initiateExternalPayment();
            }
        }
        
        function initiateExternalPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            console.log(`Initiating external payment of $${amount} via ${selectedGateway}...`);
            
            showToast('Redirecting', `Initiating redirect to ${selectedGateway} for secure checkout...`, 'primary');
            
            // In a real app, this would involve a server-side redirect call.
            // Simulate the secure redirect:
            setTimeout(() => {
                alert(`[MOCK REDIRECT] You would now be redirected to the ${selectedGateway} website to complete the $${amount.toFixed(2)} payment.`);
            }, 1000);
        }

        function viewReceipt(transactionId) {
            // Placeholder function to simulate viewing a PDF or dedicated page
            alert(`[MOCK RECEIPT] Displaying or generating receipt for Transaction ID: ${transactionId}`);
            console.log(`Viewing receipt for ${transactionId}`);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderTransactions();
            
            // Update initial pay button amount
            document.getElementById('payButtonAmount').textContent = `$${document.getElementById('paymentAmount').value}`;
            
            // Attach click listeners to gateway cards
            document.querySelectorAll('.payment-option-card').forEach(card => {
                card.addEventListener('click', () => {
                    selectGateway(card.dataset.gateway);
                });
            });

            // Update pay button amount dynamically
            document.getElementById('paymentAmount').addEventListener('input', (e) => {
                const amount = parseFloat(e.target.value) || 0.00;
                document.getElementById('payButtonAmount').textContent = `$${amount.toFixed(2)}`;
            });

            console.log("Payment Management page loaded.");
        });
    </script>
</body>
</html>